name: Release and Publish

on:
  push:
    branches:
      - release

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  id-token: write # Required for npm provenance

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          registry-url: https://registry.npmjs.org/

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm run build

      - name: üíÖ Check formatting
        run: pnpm run format:check

      - name: üîç Run linting
        run: pnpm run lint

      - name: üìò Type checking
        run: pnpm run typecheck

      - name: üß™ Run tests
        run: pnpm test

      - name: ‚úÖ Verify build artifacts
        run: |
          test -d dist || (echo "‚ùå dist directory not found" && exit 1)
          test -f dist/index.js || (echo "‚ùå dist/index.js not found" && exit 1)
          test -f dist/cli/index.js || (echo "‚ùå dist/cli/index.js not found" && exit 1)
          echo "‚úÖ All required build artifacts present"

      - name: üéôÔ∏è Test CLI functionality
        run: |
          node dist/cli/index.js --version
          node dist/cli/index.js --help
          echo "‚úÖ CLI commands working"

      - name: üìã Validate package.json
        run: |
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'bin', 'keywords', 'author', 'license', 'repository', 'bugs', 'homepage', 'engines'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              throw new Error(\`Missing required fields: \${missing.join(', ')}\`);
            }
            if (!pkg.name.startsWith('@juspay/')) {
              throw new Error('Package name must be scoped to @juspay/');
            }
            console.log('‚úÖ Package validation passed');
            console.log('üì¶ Package:', pkg.name, 'v' + pkg.version);
          "

      - name: üìñ Validate documentation
        run: |
          test -f README.md || (echo "‚ùå README.md missing" && exit 1)
          test -f CHANGELOG.md || (echo "‚ùå CHANGELOG.md missing" && exit 1)
          test -f LICENSE || (echo "‚ùå LICENSE missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "‚ùå CONTRIBUTING.md missing" && exit 1)
          echo "‚úÖ Required documentation files present"

  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
      id-token: write # Required for OIDC authentication with npm provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Upgrade npm for OIDC support
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install

      - name: Build package
        run: pnpm run build

      - name: Release with semantic-release
        run: npx semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: '0' # Disable git hooks during automated release commits

      - name: Setup Node for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@juspay'

      - name: Publish to GitHub Packages
        run: |
          if [ -f "package.json" ]; then
            echo "üì¶ Publishing to GitHub Packages..."
            pnpm publish --access public --no-git-checks --registry https://npm.pkg.github.com
            echo "‚úÖ Published to GitHub Packages successfully!"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
