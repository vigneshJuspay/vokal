name: Vokal Release Pipeline

on:
  push:
    branches: [release]
  workflow_dispatch: # Enable manual triggers

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  FORCE_COLOR: 1
  HUSKY: 0 # Disable Husky hooks in CI

jobs:
  pre-release-validation:
    name: Pre-Release Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: ğŸ›¡ï¸ Verify package integrity
        run: npm audit signatures
        continue-on-error: true

      - name: ğŸ“‹ Validate package.json
        run: |
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'bin', 'keywords', 'author', 'license', 'repository', 'bugs', 'homepage', 'engines'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              throw new Error(\`Missing required fields: \${missing.join(', ')}\`);
            }
            if (!pkg.name.startsWith('@juspay/')) {
              throw new Error('Package name must be scoped to @juspay/');
            }
            console.log('âœ… Package validation passed');
            console.log('ğŸ“¦ Package:', pkg.name, 'v' + pkg.version);
          "

      - name: ğŸ“– Validate documentation
        run: |
          test -f README.md || (echo "âŒ README.md missing" && exit 1)
          test -f CHANGELOG.md || (echo "âŒ CHANGELOG.md missing" && exit 1)
          test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md missing" && exit 1)
          echo "âœ… Required documentation files present"

  comprehensive-testing:
    name: Comprehensive Testing Suite
    runs-on: ${{ matrix.os }}
    needs: pre-release-validation

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20.x, 22.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build package
        run: npm run build

      - name: ğŸ’… Check formatting
        run: npm run format:check

      - name: ğŸ” Run linting
        run: npm run lint

      - name: ğŸ“˜ Type checking
        run: npm run typecheck

      - name: ğŸ§ª Run tests
        run: npm test

      - name: âœ… Verify build artifacts
        run: |
          test -d dist || (echo "âŒ dist directory not found" && exit 1)
          test -f dist/index.js || (echo "âŒ dist/index.js not found" && exit 1)
          test -f dist/cli/index.js || (echo "âŒ dist/cli/index.js not found" && exit 1)
          echo "âœ… All required build artifacts present"

      - name: ğŸ™ï¸ Test CLI functionality
        shell: bash
        run: |
          # Test basic CLI commands
          node dist/cli/index.js --version
          node dist/cli/index.js --help
          echo "âœ… CLI commands working"

      - name: ğŸ“¦ Test SDK imports
        run: |
          # Test CommonJS import
          node -e "const vokal = require('./dist/index.js'); console.log('âœ… CJS import works');"

          # Test ESM import
          node --input-type=module -e "import('./dist/index.js').then(() => console.log('âœ… ESM import works'));"

  documentation-build:
    name: Documentation Build Test
    runs-on: ubuntu-latest
    needs: pre-release-validation

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: ğŸ“¦ Install MkDocs
        run: |
          pip install -r requirements.txt

      - name: ğŸ—ï¸ Build documentation
        run: mkdocs build --strict --clean

      - name: âœ… Verify docs output
        run: |
          test -d site || (echo "âŒ site directory not found" && exit 1)

  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    needs: [pre-release-validation, comprehensive-testing, documentation-build]
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write # Required for OIDC Trusted Publisher
      packages: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js with npm Trusted Publishers
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build package
        run: npm run build

      - name: ğŸš€ Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run release

      - name: ğŸ“ˆ Post-release validation
        if: success()
        run: |
          echo "Waiting for package to propagate to npm..."
          sleep 10

          # Verify the package was published
          if npm view @juspay/vokal version 2>/dev/null; then
            PUBLISHED_VERSION=$(npm view @juspay/vokal version)
            echo "âœ… Package published successfully: @juspay/vokal@$PUBLISHED_VERSION"
            echo "ğŸ” Published with OIDC Trusted Publisher (keyless)"
            echo "âœ… Cryptographic provenance attestation included"
          else
            echo "âš ï¸  Package not yet available on npm (may take a few moments)"
          fi

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [release]
    if: success()
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          ref: release
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ“Š Get release information
        id: release-info
        run: |
          LATEST_VERSION=$(npm view @juspay/vokal version 2>/dev/null || node -p "require('./package.json').version")
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Released version: $LATEST_VERSION"

      - name: ğŸ‰ Release summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Vokal Release Completed Successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“¦ Package: @juspay/vokal"
          echo "ğŸ·ï¸  Version: ${{ steps.release-info.outputs.version }}"
          echo "ğŸ”— NPM: https://www.npmjs.com/package/@juspay/vokal"
          echo "ğŸ“– Documentation: https://juspay.github.io/vokal/"
          echo "ğŸ› Issues: https://github.com/juspay/vokal/issues"
          echo ""
          echo "âœ¨ Features included:"
          echo "   ğŸ™ï¸  Text-to-Speech (TTS) with background audio"
          echo "   ğŸ§ Speech-to-Text (STT) with voice activity detection"
          echo "   ğŸ¤– AI-powered response evaluation"
          echo "   ğŸ§ª Complete voice bot testing framework"
          echo "   ğŸ“Š Comprehensive test reporting"
          echo ""
          echo "ğŸ“¥ Installation:"
          echo "   npm install @juspay/vokal@${{ steps.release-info.outputs.version }}"
          echo ""
          echo "ğŸš€ Ready for production use!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  notify-failure:
    name: Release Failure Notification
    runs-on: ubuntu-latest
    needs:
      [
        pre-release-validation,
        comprehensive-testing,
        documentation-build,
        release,
      ]
    if: failure()

    steps:
      - name: ğŸš¨ Release failed
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš¨ Vokal Release Pipeline Failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Failed jobs:"
          echo "  - Pre-release validation: ${{ needs.pre-release-validation.result }}"
          echo "  - Comprehensive testing: ${{ needs.comprehensive-testing.result }}"
          echo "  - Documentation build: ${{ needs.documentation-build.result }}"
          echo "  - Release: ${{ needs.release.result }}"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "  1. Check the workflow logs for detailed error messages"
          echo "  2. Fix any issues identified in the failing jobs"
          echo "  3. Push fixes and the pipeline will run automatically"
          echo "  4. If needed, use workflow_dispatch for manual release"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
