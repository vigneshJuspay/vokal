name: Vokal CI/CD Pipeline

on:
  push:
    branches: [release]
  pull_request:
    branches: [release]
  workflow_dispatch:

env:
  FORCE_COLOR: 1
  HUSKY: 0  # Disable Husky hooks in CI

jobs:
  quality-check:
    name: Code Quality & Linting
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build TypeScript
        run: npm run build

      - name: ğŸ’… Check Prettier formatting
        run: npm run format:check

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ“˜ Type checking
        run: npm run typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quality-check

    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build project
        run: npm run build

      - name: ğŸ§ª Run unit tests
        run: npm test

      - name: âœ… Verify build artifacts
        run: |
          test -d dist || (echo "âŒ dist directory not found" && exit 1)
          test -f dist/index.js || (echo "âŒ dist/index.js not found" && exit 1)
          test -f dist/cli/index.js || (echo "âŒ dist/cli/index.js not found" && exit 1)
          echo "âœ… All required build artifacts present"

  functional-tests:
    name: Functional & Cross-Platform Tests
    runs-on: ${{ matrix.os }}
    needs: quality-check

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20.x, 22.x]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build TypeScript
        run: npm run build

      - name: ğŸ§ª Test CLI commands
        run: |
          node dist/cli/index.js --version
          node dist/cli/index.js --help
          node dist/cli/index.js test --help
          node dist/cli/index.js voices --help || true

      - name: ğŸ§ª Test SDK imports
        run: |
          # Test CommonJS imports
          node -e "const vokal = require('./dist/index.js'); console.log('âœ… CJS import works');"

          # Test ES module imports
          node --input-type=module -e "import('./dist/index.js').then(() => console.log('âœ… ESM import works'));"

      - name: ğŸ“ Test audio assets
        run: |
          test -d assets
          test -f assets/cafe-ambience.wav
          test -f assets/office-ambience.wav
          echo "âœ… Audio assets present"

      - name: ğŸ”§ Check optional audio tools
        run: |
          which sox || echo "âš ï¸ SoX not installed (optional)"
          which ffmpeg || echo "âš ï¸ FFmpeg not installed (optional)"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”’ Run npm audit (high)
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: ğŸ›¡ï¸ Check for critical vulnerabilities
        run: |
          echo "Checking for critical vulnerabilities..."
          npm audit --audit-level=critical || true

  documentation-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: ğŸ“¦ Install MkDocs
        run: |
          pip install -r requirements.txt

      - name: ğŸ“– Validate documentation structure
        run: |
          # Check required documentation files
          test -f README.md || (echo "âŒ README.md missing" && exit 1)
          test -f CHANGELOG.md || (echo "âŒ CHANGELOG.md missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md missing" && exit 1)
          test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
          echo "âœ… Required root documentation files present"

          # Check docs directory structure
          test -d docs || (echo "âŒ docs directory missing" && exit 1)
          test -f docs/index.md || (echo "âŒ docs/index.md missing" && exit 1)
          test -d docs/getting-started || (echo "âŒ docs/getting-started missing" && exit 1)
          test -d docs/user-guide || (echo "âŒ docs/user-guide missing" && exit 1)
          test -d docs/api || (echo "âŒ docs/api missing" && exit 1)
          echo "âœ… Documentation structure valid"

      - name: ğŸ—ï¸ Build documentation
        run: mkdocs build --strict --clean

      - name: âœ… Verify docs build output
        run: |
          test -d site || (echo "âŒ site directory not found" && exit 1)
          test -f site/index.html || (echo "âŒ site/index.html not found" && exit 1)
          echo "âœ… Documentation built successfully"

      - name: ğŸ“‹ Validate package.json completeness
        run: |
          node -e "
            const pkg = require('./package.json');
            const required = ['name', 'version', 'description', 'main', 'bin', 'keywords', 'author', 'license', 'repository', 'bugs', 'homepage', 'engines'];
            const missing = required.filter(field => !pkg[field]);
            if (missing.length > 0) {
              throw new Error(\`Missing required fields: \${missing.join(', ')}\`);
            }
            console.log('âœ… package.json validation passed');
            console.log('Package:', pkg.name, 'v' + pkg.version);
          "

  dependency-validation:
    name: Dependency Validation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Check for duplicate dependencies
        run: |
          npm dedupe --dry-run
          echo "âœ… No duplicate dependencies found"

      - name: ğŸ“Š List production dependencies
        run: |
          echo "Production dependencies:"
          npm ls --prod --depth=0

      - name: âš ï¸ Check for outdated packages
        run: npm outdated || true

  release-validation:
    name: Release Validation
    runs-on: ubuntu-latest
    needs: [quality-check, unit-tests, security-audit, documentation-validation]
    if: github.event_name == 'push' && github.ref == 'refs/heads/release'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build package
        run: npm run build

      - name: ğŸ“¦ Test package contents
        run: |
          npm pack --dry-run
          echo "âœ… Package contents verified"

      - name: ğŸ” Verify exports
        run: |
          node -e "
            const pkg = require('./package.json');
            console.log('Exports:', Object.keys(pkg.exports || {}));
            console.log('âœ… Package exports configured');
          "

      - name: ğŸ“‹ Validate publishConfig
        run: |
          node -e "
            const pkg = require('./package.json');
            if (!pkg.publishConfig) throw new Error('publishConfig missing');
            if (pkg.publishConfig.access !== 'public') throw new Error('publishConfig.access must be public');
            if (pkg.publishConfig.provenance !== true) throw new Error('publishConfig.provenance must be true');
            console.log('âœ… publishConfig validated for OIDC Trusted Publishers');
          "

      - name: ğŸ” Verify OIDC permissions in workflows
        run: |
          if ! grep -q "id-token: write" .github/workflows/release.yml; then
            echo "âŒ release.yml missing id-token: write permission"
            exit 1
          fi
          echo "âœ… OIDC permissions configured correctly"

  notify-success:
    name: Success Notification
    needs:
      [
        quality-check,
        unit-tests,
        functional-tests,
        security-audit,
        documentation-validation,
        dependency-validation,
      ]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: ğŸ‰ Success Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ All Vokal CI/CD checks passed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… Code quality and linting"
          echo "âœ… Unit tests (all Node versions)"
          echo "âœ… Functional tests (CLI commands)"
          echo "âœ… Cross-platform compatibility (Linux, macOS)"
          echo "âœ… Security audit"
          echo "âœ… Documentation validation (MkDocs)"
          echo "âœ… Dependency validation"
          echo ""
          echo "ğŸš€ Vokal is ready for deployment!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
